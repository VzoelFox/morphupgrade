# greenfield/examples/test_vm_compiler_wip.fox
# Tes Menjalankan Kompiler Morph di atas Native VM

# --- Imports Host VM ---
ambil_semua "greenfield/fox_vm/prosesor.fox" sebagai Proc
ambil_semua "greenfield/cotc/bytecode/struktur.fox" sebagai S
ambil_semua "greenfield/cotc/bytecode/opkode.fox" sebagai Opc
ambil_semua "greenfield/lx_morph.fox" sebagai LexerModul
ambil_semua "greenfield/crusher.fox" sebagai ParserModul
ambil_semua "greenfield/kompiler/utama.fox" sebagai CompilerModul
ambil_semua "greenfield/kompiler/generator.fox" sebagai GenModul
ambil_semua "greenfield/kompiler/ekspresi.fox" sebagai EkspresiModul
ambil_semua "greenfield/kompiler/pernyataan.fox" sebagai PernyataanModul
ambil_semua "greenfield/kompiler/kelas.fox" sebagai KelasModul
ambil_semua "greenfield/kompiler/analisis.fox" sebagai AnalisisModul
ambil_semua "greenfield/morph_t.fox" sebagai T
ambil_semua "greenfield/absolute_syntax_morph.fox" sebagai AST_Modul
ambil_semua "greenfield/handler.fox" sebagai H
ambil_semua "greenfield/cotc/stdlib/core.fox" sebagai CoreLib
dari "greenfield/cotc/stdlib/teks.fox" ambil_sebagian iris
ambil_semua "greenfield/cotc/warna.fox" sebagai Warna

pinjam "builtins" sebagai py
pinjam "operator" sebagai py_op
pinjam "ivm.core.structs" sebagai structs

biar getattr = py.getattr
biar setattr = py.setattr
biar setitem = py_op.setitem
biar getitem = py_op.getitem
biar contains = py_op.contains
biar BoundMethod = structs.BoundMethod
biar MorphInstance = structs.MorphInstance
biar MorphClass = structs.MorphClass
biar callable = py.callable
biar isinstance = py.isinstance

# --- Bridges ---

fungsi _native_getattr(obj, nama) maka
    # Debug
    # CoreLib["tulis"]("GETATTR " + CoreLib["teks"](nama) + " on " + CoreLib["teks"](obj))

    biar res = nil

    # 0. Special Handling for __class__ on MorphInstance
    jika nama == "__class__" dan isinstance(obj, MorphInstance) maka
        kembali getattr(obj, "klass")
    akhir

    # 1. Coba getattr standar
    coba
        ubah res = getattr(obj, nama)
        kembali res
    tangkap e
        # Lanjut
    akhir
    coba
        biar props = getattr(obj, "properties")
        jika props != nil dan contains(props, nama) maka
            kembali props[nama]
        akhir
    tangkap e
        # Ignore
    akhir
    coba
        biar klass = getattr(obj, "klass")
        jika klass != nil maka
            biar curr = klass
            selama curr != nil maka
                biar methods = getattr(curr, "methods")
                jika contains(methods, nama) maka
                    kembali BoundMethod(obj, methods[nama])
                akhir
                ubah curr = getattr(curr, "superclass")
            akhir
        akhir
    tangkap e
        # Ignore
    akhir

    kembali nil
akhir

fungsi _native_setattr(obj, nama, nilai) maka
    coba
        kembali setattr(obj, nama, nilai)
    tangkap e
        coba
            biar props = getattr(obj, "properties")
            ubah props[nama] = nilai
        tangkap e2
            pass
        akhir
    akhir
akhir

fungsi _native_call_host(obj, args) maka
    # Handle MorphClass Instantiation manually
    jika isinstance(obj, MorphClass) maka
        biar inst = MorphInstance(obj)
        biar inisiasi_method = nil
        coba
            ubah inisiasi_method = getattr(inst, "inisiasi")
        tangkap e
            ubah inisiasi_method = nil
        akhir
        jika inisiasi_method != nil maka
             _native_call_host(inisiasi_method, args)
        akhir
        kembali inst
    akhir

    biar n = CoreLib["panjang"](args)
    jika n == 0 maka kembali obj() akhir
    jika n == 1 maka kembali obj(args[0]) akhir
    jika n == 2 maka kembali obj(args[0], args[1]) akhir
    jika n == 3 maka kembali obj(args[0], args[1], args[2]) akhir
    jika n == 4 maka kembali obj(args[0], args[1], args[2], args[3]) akhir
    jika n == 5 maka kembali obj(args[0], args[1], args[2], args[3], args[4]) akhir
    kembali nil
akhir

fungsi _native_buat_instance(cls) maka
    kembali MorphInstance(cls)
akhir

fungsi _native_is_callable(obj) maka
    jika callable(obj) maka kembali benar akhir
    jika isinstance(obj, MorphClass) maka kembali benar akhir
    kembali salah
akhir

fungsi copy_exports_dict(sumber, target) maka
    biar keys = py.list(sumber)
    biar len_keys = CoreLib["panjang"](keys)
    biar i = 0
    selama i < len_keys maka
        biar k = keys[i]
        jika k != "__name__" dan k != "__doc__" dan k != "__package__" dan k != "__loader__" dan k != "__spec__" dan k != "__file__" dan k != "__cached__" dan k != "__builtins__" maka
             biar val = sumber[k]
             setitem(target, k, val)
        akhir
        ubah i = i + 1
    akhir
akhir

# Konversi Host CodeObject ke Native ObjekKode
fungsi konversi_kode(host_code) maka
    biar name = host_code.name
    biar inst_host = host_code.instructions
    biar inst_native = []

    biar len_inst = CoreLib["panjang"](inst_host)
    biar i = 0
    selama i < len_inst maka
        biar op_tuple = inst_host[i]
        biar op = op_tuple[0]
        biar arg = nil
        jika CoreLib["panjang"](op_tuple) > 1 maka
            ubah arg = op_tuple[1]
        akhir
        CoreLib["tambah"](inst_native, [op, arg])
        ubah i = i + 1
    akhir

    biar args_host = host_code.arg_names
    biar args_native = []
    biar len_args = CoreLib["panjang"](args_host)
    biar j = 0
    selama j < len_args maka
        CoreLib["tambah"](args_native, args_host[j])
        ubah j = j + 1
    akhir

    kembali S.ObjekKode(name, inst_native, args_native, [])
akhir

# Hoisted helper
fungsi _wrap_iris(obj, awal, akhir_pos) maka
    kembali iris(obj, awal, akhir_pos)
akhir

# Fungsi Setup Terpisah - Core
fungsi setup_cache_core(cpu, NativeFunc) maka
    biar cache = cpu.modules

    # 1. Morph Token (T)
    biar T_exports = {}
    copy_exports_dict(T, T_exports)
    setitem(cache, "morph_t.fox", T_exports)
    setitem(cpu.globals, "T", T_exports)

    # 2. Handler (H)
    biar H_exports = {}
    setitem(H_exports, "PengelolaKesalahan", H.PengelolaKesalahan)
    setitem(cache, "handler.fox", H_exports)

    # 3. Stdlib Core
    biar Core_exports = {}
    setitem(Core_exports, "panjang", cpu.globals["panjang"])
    setitem(Core_exports, "tambah", cpu.globals["tambah"])
    setitem(Core_exports, "gabung", CoreLib["gabung"])
    setitem(Core_exports, "float", CoreLib["float"])
    setitem(Core_exports, "int", CoreLib["int"])
    setitem(Core_exports, "tipe_objek", CoreLib["tipe_objek"])
    setitem(Core_exports, "teks", CoreLib["teks"])
    setitem(Core_exports, "tulis", CoreLib["tulis"])
    setitem(cache, "cotc(stdlib)/core.fox", Core_exports)

    # 4. Stdlib Teks
    biar Teks_exports = {}
    setitem(Teks_exports, "iris", NativeFunc("iris", _wrap_iris))
    setitem(cache, "cotc(stdlib)/teks.fox", Teks_exports)

    # 5. Warna
    biar Warna_exports = {}
    setitem(Warna_exports, "MERAH", Warna.MERAH)
    setitem(Warna_exports, "KUNING", Warna.KUNING)
    setitem(cache, "cotc/warna.fox", Warna_exports)
akhir

# Fungsi Setup Terpisah - Compiler
fungsi setup_cache_compiler(cpu) maka
    biar cache = cpu.modules

    # 6. Lexer Modul
    biar Lexer_exports = {}
    setitem(Lexer_exports, "Leksikal", LexerModul.Leksikal)
    setitem(cache, "lx_morph.fox", Lexer_exports)
    setitem(cpu.globals, "LexerModul", Lexer_exports)
    setitem(cpu.globals, "Lexer", Lexer_exports)

    # 7. AST Modul
    biar AST_exports = {}
    copy_exports_dict(AST_Modul, AST_exports)
    setitem(cache, "absolute_syntax_morph.fox", AST_exports)
    setitem(cpu.globals, "AST", AST_exports)

    # 8. Compiler Modules
    biar Gen_exports = {}
    copy_exports_dict(GenModul, Gen_exports)
    setitem(cache, "greenfield/kompiler/generator.fox", Gen_exports)
    setitem(cpu.globals, "Gen", Gen_exports)

    biar Ekspresi_exports = {}
    copy_exports_dict(EkspresiModul, Ekspresi_exports)
    setitem(cache, "greenfield/kompiler/ekspresi.fox", Ekspresi_exports)
    setitem(cpu.globals, "Ekspresi", Ekspresi_exports)

    biar Pernyataan_exports = {}
    copy_exports_dict(PernyataanModul, Pernyataan_exports)
    setitem(cache, "greenfield/kompiler/pernyataan.fox", Pernyataan_exports)
    setitem(cpu.globals, "Pernyataan", Pernyataan_exports)

    biar Kelas_exports = {}
    copy_exports_dict(KelasModul, Kelas_exports)
    setitem(cache, "greenfield/kompiler/kelas.fox", Kelas_exports)
    setitem(cpu.globals, "Kelas", Kelas_exports)

    biar Analisis_exports = {}
    copy_exports_dict(AnalisisModul, Analisis_exports)
    setitem(cache, "greenfield/kompiler/analisis.fox", Analisis_exports)
    setitem(cpu.globals, "Analisis", Analisis_exports)

    # 9. Opcode & Struktur
    biar Opc_exports = {}
    copy_exports_dict(Opc, Opc_exports)
    setitem(cache, "greenfield/cotc/bytecode/opkode.fox", Opc_exports)
    setitem(cpu.globals, "Opcode", Opc_exports)

    biar S_exports = {}
    copy_exports_dict(S, S_exports)
    setitem(cache, "greenfield/cotc/bytecode/struktur.fox", S_exports)
    setitem(cpu.globals, "Struktur", S_exports)
akhir

fungsi utama() maka
    CoreLib["tulis"]("--- Persiapan Native VM untuk Kompiler ---")

    biar cpu = Proc.Prosesor()
    cpu.inisiasi()

    biar NativeFunc = cpu.globals["panjang"].__class__
    setitem(cpu.globals, "_getattr", NativeFunc("_getattr", _native_getattr))
    setitem(cpu.globals, "_setattr", NativeFunc("_setattr", _native_setattr))

    # Expose bridges
    setitem(cpu.globals, "_getitem", NativeFunc("_getitem", getitem))
    setitem(cpu.globals, "_setitem", NativeFunc("_setitem", setitem))
    setitem(cpu.globals, "_host_contains", NativeFunc("_host_contains", contains))
    setitem(cpu.globals, "_call_host", NativeFunc("_call_host", _native_call_host))
    setitem(cpu.globals, "_buat_instance", NativeFunc("_buat_instance", _native_buat_instance))
    setitem(cpu.globals, "_is_callable", NativeFunc("_is_callable", _native_is_callable))

    setup_cache_core(cpu, NativeFunc)
    setup_cache_compiler(cpu)

    # --- Pipeline di Host Side ---
    biar sumber_kode = "biar x = 10"
    biar err_handler = H.PengelolaKesalahan()

    # 1. Lexer
    biar lexer_host = LexerModul.Leksikal(sumber_kode, "test_native_compiler.fox", err_handler)
    biar daftar_token = lexer_host.buat_token()

    # 2. Parser
    biar parser_host = ParserModul.Pengurai(daftar_token, err_handler)
    biar ast = parser_host.urai()

    # 3. Compiler
    biar compiler_host = CompilerModul.Kompiler()
    compiler_host.inisiasi()

    # Ambil method 'kompilasi'
    biar method_kompilasi = compiler_host.kompilasi
    biar fungsi_morph = method_kompilasi.method
    biar kode_kompilasi_host = fungsi_morph.code

    biar kode_native = konversi_kode(kode_kompilasi_host)

    CoreLib["tulis"]("CodeObject Kompiler siap. Tipe: " + CoreLib["tipe_objek"](kode_native))

    # --- Jalankan di Native VM ---
    biar TabelOp = Opc.Op
    biar instruksi_wrapper = []

    CoreLib["tambah"](instruksi_wrapper, [TabelOp["PUSH_CONST"], kode_native])    # Callee
    CoreLib["tambah"](instruksi_wrapper, [TabelOp["PUSH_CONST"], compiler_host])  # Arg 0: ini
    CoreLib["tambah"](instruksi_wrapper, [TabelOp["PUSH_CONST"], ast])            # Arg 1: node
    CoreLib["tambah"](instruksi_wrapper, [TabelOp["CALL"], 2])                    # Call 2 Args
    CoreLib["tambah"](instruksi_wrapper, [TabelOp["PRINT"], 1])                   # Print Result
    CoreLib["tambah"](instruksi_wrapper, [TabelOp["PUSH_CONST"], nil])            # Return value (nil)
    CoreLib["tambah"](instruksi_wrapper, [TabelOp["RET"], nil])

    biar wrapper_kode = S.ObjekKode("wrapper_compiler_test", instruksi_wrapper, [], [])

    CoreLib["tulis"]("--- Mengeksekusi Wrapper Kompiler ---")
    cpu.jalan(wrapper_kode)
    CoreLib["tulis"]("--- Selesai Eksekusi ---")
akhir
