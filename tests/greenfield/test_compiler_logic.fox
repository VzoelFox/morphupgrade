# tests/greenfield/test_compiler_logic.fox
# Tes Logika Kompiler (Variabel, Loop, If)

dari "greenfield/lx_morph.fox" ambil_sebagian Leksikal
dari "greenfield/crusher.fox" ambil_sebagian Pengurai
dari "greenfield/handler.fox" ambil_sebagian PengelolaKesalahan
dari "greenfield/kompiler.fox" ambil_sebagian Kompiler
dari "greenfield/cotc/stdlib/core.fox" ambil_sebagian teks, panjang, tipe_objek, tambah

# Helper Cetak Bytecode
fungsi cetak_bytecode(instruksi) maka
    tulis("--- Bytecode (" + teks(panjang(instruksi)) + " instruksi) ---")
    biar i = 0
    selama i < panjang(instruksi) maka
        biar instr = instruksi[i]
        biar op = instr[0]
        biar arg = instr[1]

        # Format: [Index] OP ARG
        biar baris = "[" + teks(i) + "] " + teks(op)
        jika arg != nil maka
            ubah baris = baris + " " + teks(arg)
        akhir
        tulis(baris)

        ubah i = i + 1
    akhir
akhir

fungsi tes_kompilasi(kode, nama_tes) maka
    tulis("\n=== Tes: " + nama_tes + " ===")
    tulis("Kode:\n" + kode)

    biar handler = PengelolaKesalahan()
    biar lexer = Leksikal(kode, "tes.fox", handler)
    biar tokens = lexer.buat_token()

    jika handler.ada_error maka
        tulis("Gagal Lexing!")
        kembali nil
    akhir

    biar parser = Pengurai(tokens, handler)
    coba
        biar ast = parser.urai()
        jika handler.ada_error maka
            tulis("Gagal Parsing!")
            handler.cetak_laporan(kode)
            kembali nil
        akhir

        tulis("Memulai Kompilasi...")
        biar kompiler = Kompiler()
        biar bytecode = kompiler.kompilasi(ast)
        cetak_bytecode(bytecode)

    tangkap e
        tulis("Gagal Kompilasi (Exception Caught).")
        tulis(e)
    akhir
akhir

# 1. Variabel
tes_kompilasi("biar x = 10\ntulis(x)", "Variabel")

# 2. Assignment
tes_kompilasi("biar x = 1\nubah x = x + 1", "Assignment")

# 3. If/Else
tes_kompilasi("jika benar maka\n  tulis('Ya')\nlain\n  tulis('Tidak')\nakhir", "If/Else")

# 4. Loop
tes_kompilasi("selama x < 5 maka\n  ubah x = x + 1\nakhir", "Loop")
