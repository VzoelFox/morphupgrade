# tests/greenfield/test_function_compilation.fox
# Tes Kompilasi Fungsi (Deklarasi, Panggil, Return)

dari "greenfield/lx_morph.fox" ambil_sebagian Leksikal
dari "greenfield/crusher.fox" ambil_sebagian Pengurai
dari "greenfield/handler.fox" ambil_sebagian PengelolaKesalahan
dari "greenfield/kompiler/utama.fox" ambil_sebagian Kompiler
dari "greenfield/cotc/stdlib/core.fox" ambil_sebagian teks, panjang, tipe_objek, tambah

fungsi cetak_bytecode(instruksi) maka
    tulis("--- Bytecode (" + teks(panjang(instruksi)) + " instruksi) ---")
    biar i = 0
    selama i < panjang(instruksi) maka
        biar ins = instruksi[i]
        tulis("[" + teks(i) + "] " + teks(ins[0]) + " " + teks(ins[1]))
        ubah i = i + 1
    akhir
akhir

fungsi tes_kompilasi(kode, nama_tes) maka
    tulis("\n=== Tes: " + nama_tes + " ===")
    tulis("Kode:\n" + kode)

    biar handler = PengelolaKesalahan()
    biar lexer = Leksikal(kode, "tes.fox", handler)
    biar tokens = lexer.buat_token()

    jika handler.ada_error maka
        tulis("Gagal Lexing!")
        kembali nil
    akhir

    biar parser = Pengurai(tokens, handler)
    coba
        biar ast = parser.urai()
        jika handler.ada_error maka
            tulis("Gagal Parsing!")
            handler.cetak_laporan(kode)
            kembali nil
        akhir

        tulis("Memulai Kompilasi...")
        biar kompiler = Kompiler()
        biar bytecode = kompiler.kompilasi(ast)
        cetak_bytecode(bytecode)
        tulis("Kompilasi Berhasil.")
    tangkap e
        tulis("Gagal Kompilasi (Exception):")
        tulis(e)
    akhir
akhir

# Tes 1: Fungsi Sederhana
# Perhatikan: Newline wajib setelah 'maka'
tes_kompilasi("fungsi sapa() maka\n tulis('Halo')\n akhir\n\nsapa()", "Fungsi Sederhana")

# Tes 2: Fungsi dengan Parameter dan Return
tes_kompilasi("fungsi kali(a, b) maka\n kembali a * b\n akhir\n\nbiar hasil = kali(10, 2)\ntulis(hasil)", "Parameter & Return")

# Tes 3: Fungsi Rekursif (untuk menguji scoping/call stack)
tes_kompilasi("fungsi faktorial(n) maka\n jika n < 2 maka\n kembali 1\n lain\n kembali n * faktorial(n-1)\n akhir\n akhir\n\ntulis(faktorial(5))", "Rekursi")
