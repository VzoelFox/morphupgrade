name: Morph CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  test-python-host:
    name: Test Morph (Python Host)
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - name: Set up Python 3.10
      uses: actions/setup-python@v4
      with:
        python-version: "3.10"
    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
    - name: Verify CLI
      run: python3 -m ivm.main greenfield/verifikasi.fox greenfield/morph.fox
    - name: Run Self-Hosted Tests
      run: python3 -m ivm.main greenfield/uji_semua.fox

  build-rust-vm:
    name: Build Native VM (Rust)
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - name: Set up Rust
      uses: actions-rs/toolchain@v1
      with:
        toolchain: stable
        override: true
    - name: Check Rust VM
      run: |
        cd greenfield/morph_vm
        cargo check --verbose
    - name: Test Rust VM
      run: |
        cd greenfield/morph_vm
        cargo test --verbose

    - name: Build Release Binary
      run: |
        cd greenfield/morph_vm
        cargo build --release --verbose
